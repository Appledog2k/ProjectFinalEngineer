@model ProjectFinalEngineer.Models.RoomingHouse.RoomingHouseViewModel
<head>
    <link rel="stylesheet" href="~/css/CommentPartial.css">
</head>

<body>
    <div class="row mt-5" id="comments">
        <div>
            <h3 class="count-comment">@Model.RoomingHouse.Comments.Count() bình luận</h3>
            <ul class="comment-list  comment-top" list="@Model.RoomingHouse.Comments" count="0">
                @foreach (var comment in Model.RoomingHouse.Comments.Where(comment => comment.Parent is null))
                {
                    <li class="comment">
                        <div class="contact-element-avatar-1">
                            <img class="ct-image" src="~/images/avatars/default-avatar-23.webp">
                        </div>
                        <div class="comment-body">

                            <h4 class="commenter-name">@comment.Author.UserName</h4>
                            <div class="comment-date">@comment.CreatedOn.ToString("MMMM d, yyyy hh:mm tt")</div>
                            <p class="comment-message">@comment.Content</p>
                            @*  @if (!User.Identity.IsAuthenticated)
                        {
                        <a class="reply-btn btn" asp-page="/Account/Login" asp-route-ReturnUrl="~/forum/article/Details/@Model.Post.PostId">Login to reply</a>
                        }
                        else
                        {
                        <a aria-expanded="false" href="@($"#replyComment{comment.Id}")" data-toggle="collapse" class="reply-btn btn reply-button">Trả lời</a>
                        }*@
                        </div>
                        <ul class="comment-list" list="@comment.Comments" count="0">
                            @foreach (var reply in comment.Comments)
                            {
                                <li class="comment-reply">
                                    <div class="contact-element-avatar-1">
                                        <img class="ct-image" src="~/images/avatars/default-avatar-23.webp">
                                    </div>
                                    <div class="comment-body">
                                        <h3 class="commenter-name">@reply.Author.UserName</h3>
                                        <div class="comment-date">@reply.CreatedOn.ToString("MMMM d, yyyy hh:mm tt")</div>
                                        <p class="comment-message">@reply.Content</p>
                                    </div>
                                </li>
                            }
                        </ul>
                        @if (User.Identity.IsAuthenticated)
                        {
                            <div class="collapse reply-comment" id="@($"replyComment{comment.Id}")">
                                <form asp-controller="RoomingHouse" asp-action="Comment" id="commentForm">
                                    <input asp-for="RoomingHouse.Id" readonly hidden />
                                    <input asp-for="Comment.Parent.Id" value="@comment.Id" readonly hidden />
                                    <div class="form-group">
                                        <label for="comment">Trả lời bình luận</label>
                                        <textarea asp-for="Comment.Content" class="form-control" rows="3" required></textarea>
                                        <button id="btnComment" type="submit" class="btn btn-outline-primary post-btn">Trả lời</button>
                                    </div>
                                </form>
                            </div>
                        }

                    </li>
                }
            </ul>

            @if (User.Identity.IsAuthenticated)
            {
                <div class="comment-first">
                    <form asp-controller="RoomingHouse" asp-action="Comment">
                        <input asp-for="RoomingHouse.Id" readonly hidden />
                        <div class="form-group">
                            <label for="comment">Bình luận</label>
                            <textarea asp-for="Comment.Content" class="form-control" rows="3" required placeholder="Vui lòng bình luận tại đây"></textarea>
                            <button type="submit" class="btn btn-outline-primary post-btn">Gửi bình luận</button>
                        </div>
                    </form>
                </div>
            }
            else
            {
                <div class="show-login">
                    <a class="reply-btn btn" asp-controller="Account" asp-action="Login" asp-route-ReturnUrl="~/forum/article/Details/@Model.RoomingHouse.Id">Đăng nhập để bình luận bài viết</a>
                </div>

            }
        </div>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://kit.fontawesome.com/7c8801c017.js" crossorigin="anonymous"></script>
</body>
@section Scripts{
    <script>

        $('[data-toggle="collapse"]').on('click', function () {
            var $this = $(this),
                $parent = typeof $this.data('parent') !== 'undefined' ? $($this.data('parent')) : undefined;
            if ($parent === undefined) { /* Just toggle my  */
                $this.find('.glyphicon').toggleClass('glyphicon-plus glyphicon-minus');
                return true;
            }

            /* Open element will be close if parent !== undefined */
            var currentIcon = $this.find('.glyphicon');
            currentIcon.toggleClass('glyphicon-plus glyphicon-minus');
            $parent.find('.glyphicon').not(currentIcon).removeClass('glyphicon-minus').addClass('glyphicon-plus');

        });
        function sendComment() {
            var formData = new FormData($('#commentForm')[0]);
            $.ajax({
                url: '@Url.Action("Comment", "RoomingHouse")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (result) {
                    $('#comments').html(result);
                },
                error: function () {
                    // Xử lý lỗi
                }
            });
        }
        $('#commentForm').submit(function (e) {
            e.preventDefault();
            sendComment();
        });



    </script>
}
